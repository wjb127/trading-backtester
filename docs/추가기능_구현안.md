# Trading Backtest ì¶”ê°€ ê¸°ëŠ¥ êµ¬í˜„ì•ˆ

## í”„ë¡œì íŠ¸ í˜„ì¬ ìƒíƒœ

### ì™„ë£Œëœ ê¸°ëŠ¥
- âœ… ë°±ì—”ë“œ API ê¸°ë³¸ êµ¬ì¡° (FastAPI + Supabase REST API)
- âœ… í”„ë¡ íŠ¸ì—”ë“œ ê¸°ë³¸ êµ¬ì¡° (Next.js 14 + TypeScript + Tailwind CSS)
- âœ… Supabase ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì„¤ê³„
- âœ… ì „ëµ ê´€ë¦¬ API (CRUD)
- âœ… ê¸°ë³¸ í˜ì´ì§€ êµ¬ì¡° (ëŒ€ì‹œë³´ë“œ, ì „ëµ, ë°±í…ŒìŠ¤íŠ¸)

### ë¯¸ì™„ì„± ê¸°ëŠ¥ (Placeholder)
- ğŸ”² ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì—”ì§„
- ğŸ”² ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘ ë° ì €ì¥
- ğŸ”² ì„±ê³¼ ë¶„ì„ ë° í†µê³„
- ğŸ”² ì°¨íŠ¸ ë° ì‹œê°í™”

---

## 1ë‹¨ê³„: ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì—”ì§„

### 1.1 ì „ëµ ì‹¤í–‰ ì—”ì§„
**ëª©í‘œ**: ì‚¬ìš©ìê°€ ì‘ì„±í•œ ì „ëµ ì½”ë“œë¥¼ ì•ˆì „í•˜ê²Œ ì‹¤í–‰í•˜ê³  ë§¤ë§¤ ì‹ í˜¸ë¥¼ ìƒì„±

#### êµ¬í˜„ ë‚´ìš©
```python
# backend/app/services/backtest_engine.py

class BacktestEngine:
    """ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì—”ì§„"""

    def __init__(self, strategy_code: str, parameters: dict):
        self.strategy_code = strategy_code
        self.parameters = parameters

    def execute(self, market_data: pd.DataFrame) -> BacktestResult:
        """ì „ëµ ì‹¤í–‰ ë° ë°±í…ŒìŠ¤íŠ¸ ìˆ˜í–‰"""
        # 1. ì „ëµ ì½”ë“œ ê²€ì¦ (ë³´ì•ˆ)
        # 2. ì „ëµ ì‹¤í–‰ í™˜ê²½ ì„¤ì •
        # 3. ë§¤ë§¤ ì‹ í˜¸ ìƒì„±
        # 4. í¬ì§€ì…˜ ê´€ë¦¬ ë° ê±°ë˜ ì‹œë®¬ë ˆì´ì…˜
        # 5. ì„±ê³¼ ê³„ì‚°
        pass
```

#### ì£¼ìš” ê¸°ëŠ¥
- **ì½”ë“œ ìƒŒë“œë°•ì‹±**: `RestrictedPython` ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•œ ì½”ë“œ ì‹¤í–‰
- **ì§€í‘œ ë¼ì´ë¸ŒëŸ¬ë¦¬**: `TA-Lib`, `pandas-ta` í†µí•©
- **í¬ì§€ì…˜ ê´€ë¦¬**: ë¡±/ìˆ í¬ì§€ì…˜, ë ˆë²„ë¦¬ì§€, ìˆ˜ìˆ˜ë£Œ ê³„ì‚°
- **ìŠ¬ë¦¬í”¼ì§€ ëª¨ë¸ë§**: ì‹¤ì œ ê±°ë˜ì™€ ìœ ì‚¬í•œ í™˜ê²½ êµ¬í˜„

#### API ì—”ë“œí¬ì¸íŠ¸
```
POST /api/v1/backtests
- Request Body: { strategy_id, symbol, start_date, end_date, initial_capital }
- Response: { backtest_id, status }

GET /api/v1/backtests/{backtest_id}/status
- Response: { status, progress, current_step }

GET /api/v1/backtests/{backtest_id}/result
- Response: { trades, metrics, equity_curve }
```

---

## 2ë‹¨ê³„: ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘

### 2.1 ë°ì´í„° ì†ŒìŠ¤ í†µí•©
**ëª©í‘œ**: ì£¼ì‹ ë° ì•”í˜¸í™”í ê³¼ê±° ë°ì´í„° ìˆ˜ì§‘ ë° ì €ì¥

#### ì§€ì› ë°ì´í„° ì†ŒìŠ¤
1. **ì£¼ì‹ ë°ì´í„°**
   - Yahoo Finance API (`yfinance`)
   - Alpha Vantage API
   - í•œêµ­íˆ¬ìì¦ê¶Œ API (KIS Developers)

2. **ì•”í˜¸í™”í ë°ì´í„°**
   - Binance API
   - Upbit API
   - CoinGecko API

#### êµ¬í˜„ ë‚´ìš©
```python
# backend/app/services/data_collector.py

class DataCollector:
    """ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘ê¸°"""

    async def fetch_historical_data(
        self,
        symbol: str,
        start_date: str,
        end_date: str,
        interval: str = "1d"
    ) -> pd.DataFrame:
        """ê³¼ê±° ë°ì´í„° ìˆ˜ì§‘ (OHLCV)"""
        pass

    async def save_to_database(self, data: pd.DataFrame):
        """Supabase bt_market_data í…Œì´ë¸”ì— ì €ì¥"""
        pass
```

#### API ì—”ë“œí¬ì¸íŠ¸
```
GET /api/v1/data/symbols
- Query: { asset_type: "stock" | "crypto" }
- Response: [ { symbol, name, exchange } ]

POST /api/v1/data/import
- Request Body: { symbol, start_date, end_date, interval }
- Response: { success, records_imported }

GET /api/v1/data/historical
- Query: { symbol, start_date, end_date }
- Response: [ { timestamp, open, high, low, close, volume } ]
```

---

## 3ë‹¨ê³„: ì„±ê³¼ ë¶„ì„ ë° í†µê³„

### 3.1 ë°±í…ŒìŠ¤íŠ¸ ì„±ê³¼ ì§€í‘œ
**ëª©í‘œ**: ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë‹¤ì–‘í•œ ì§€í‘œë¡œ ë¶„ì„

#### ì£¼ìš” ì§€í‘œ
1. **ìˆ˜ìµì„± ì§€í‘œ**
   - ì´ ìˆ˜ìµë¥  (Total Return)
   - ì—°ê°„ ìˆ˜ìµë¥  (Annual Return)
   - ìµœëŒ€ ë‚™í­ (Maximum Drawdown)
   - ìŠ¹ë¥  (Win Rate)
   - ì†ìµë¹„ (Profit Factor)

2. **ë¦¬ìŠ¤í¬ ì§€í‘œ**
   - ìƒ¤í”„ ë¹„ìœ¨ (Sharpe Ratio)
   - ì†Œë¥´í‹°ë…¸ ë¹„ìœ¨ (Sortino Ratio)
   - ë³€ë™ì„± (Volatility)

3. **ê±°ë˜ ì§€í‘œ**
   - ì´ ê±°ë˜ íšŸìˆ˜
   - í‰ê·  ë³´ìœ  ê¸°ê°„
   - í‰ê·  ìˆ˜ìµ/ì†ì‹¤

#### êµ¬í˜„ ë‚´ìš©
```python
# backend/app/services/analytics.py

class PerformanceAnalyzer:
    """ì„±ê³¼ ë¶„ì„ê¸°"""

    def calculate_metrics(self, trades: List[Trade]) -> dict:
        """ì„±ê³¼ ì§€í‘œ ê³„ì‚°"""
        return {
            "total_return": self._calculate_total_return(),
            "sharpe_ratio": self._calculate_sharpe_ratio(),
            "max_drawdown": self._calculate_max_drawdown(),
            "win_rate": self._calculate_win_rate(),
            # ...
        }
```

#### API ì—”ë“œí¬ì¸íŠ¸
```
GET /api/v1/analytics/metrics
- Query: { backtest_id }
- Response: { total_return, sharpe_ratio, max_drawdown, ... }

GET /api/v1/analytics/compare
- Query: { backtest_ids: [id1, id2, id3] }
- Response: [ { backtest_id, strategy_name, metrics } ]
```

---

## 4ë‹¨ê³„: ì°¨íŠ¸ ë° ì‹œê°í™”

### 4.1 í”„ë¡ íŠ¸ì—”ë“œ ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬
**ëª©í‘œ**: ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ì‹œê°ì ìœ¼ë¡œ í‘œí˜„

#### ì‚¬ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬
- **Chart.js** ë˜ëŠ” **Recharts**: ì„±ê³¼ ì°¨íŠ¸
- **Lightweight Charts** (TradingView): ìº”ë“¤ìŠ¤í‹± ì°¨íŠ¸
- **D3.js**: ê³ ê¸‰ ì‹œê°í™” (ì„ íƒ)

#### êµ¬í˜„í•  ì°¨íŠ¸
1. **ìˆ˜ìµ ê³¡ì„  (Equity Curve)**
   - ì‹œê°„ì— ë”°ë¥¸ í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì¹˜ ë³€í™”
   - ë²¤ì¹˜ë§ˆí¬ ë¹„êµ (Buy & Hold)

2. **ë§¤ë§¤ ì‹ í˜¸ ì°¨íŠ¸**
   - ìº”ë“¤ìŠ¤í‹± + ë§¤ìˆ˜/ë§¤ë„ ë§ˆì»¤
   - ì§€í‘œ ì˜¤ë²„ë ˆì´ (ì´ë™í‰ê· , RSI ë“±)

3. **ë‚™í­ ì°¨íŠ¸ (Drawdown Chart)**
   - ì‹œê°„ì— ë”°ë¥¸ ë‚™í­ ë³€í™”

4. **ì›”ë³„ ìˆ˜ìµë¥  íˆíŠ¸ë§µ**
   - ì›”ë³„, ì—°ë„ë³„ ìˆ˜ìµë¥  ë¶„í¬

#### êµ¬í˜„ ì˜ˆì‹œ
```typescript
// frontend/src/components/charts/EquityCurve.tsx

import { Line } from 'react-chartjs-2';

export default function EquityCurve({ data }) {
  const chartData = {
    labels: data.dates,
    datasets: [
      {
        label: 'Portfolio Value',
        data: data.equity,
        borderColor: 'rgb(75, 192, 192)',
      },
      {
        label: 'Buy & Hold',
        data: data.benchmark,
        borderColor: 'rgb(255, 99, 132)',
      }
    ]
  };

  return <Line data={chartData} />;
}
```

---

## 5ë‹¨ê³„: ì „ëµ ìµœì í™”

### 5.1 íŒŒë¼ë¯¸í„° ìµœì í™”
**ëª©í‘œ**: ì „ëµì˜ ìµœì  íŒŒë¼ë¯¸í„° ìë™ íƒìƒ‰

#### ìµœì í™” ë°©ë²•
1. **ê·¸ë¦¬ë“œ ì„œì¹˜ (Grid Search)**
   - ëª¨ë“  íŒŒë¼ë¯¸í„° ì¡°í•© íƒìƒ‰
   - ê³„ì‚° ë¹„ìš© ë†’ìŒ

2. **ë¬´ì‘ìœ„ ì„œì¹˜ (Random Search)**
   - ë¬´ì‘ìœ„ íŒŒë¼ë¯¸í„° ìƒ˜í”Œë§
   - ê·¸ë¦¬ë“œ ì„œì¹˜ë³´ë‹¤ íš¨ìœ¨ì 

3. **ë² ì´ì§€ì•ˆ ìµœì í™” (Bayesian Optimization)**
   - ê³¼ê±° ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ íŒŒë¼ë¯¸í„° ì„ íƒ
   - ê°€ì¥ íš¨ìœ¨ì 

#### êµ¬í˜„ ë‚´ìš©
```python
# backend/app/services/optimizer.py

class StrategyOptimizer:
    """ì „ëµ íŒŒë¼ë¯¸í„° ìµœì í™”"""

    def optimize(
        self,
        strategy: Strategy,
        param_ranges: dict,
        market_data: pd.DataFrame,
        method: str = "grid"
    ) -> OptimizationResult:
        """íŒŒë¼ë¯¸í„° ìµœì í™” ìˆ˜í–‰"""
        pass
```

#### API ì—”ë“œí¬ì¸íŠ¸
```
POST /api/v1/strategies/{strategy_id}/optimize
- Request Body: { param_ranges, optimization_method }
- Response: { job_id, status }

GET /api/v1/strategies/optimization/{job_id}/status
- Response: { status, progress, best_params, best_score }
```

---

## 6ë‹¨ê³„: ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ (ì„ íƒ)

### 6.1 ì‹¤ì‹œê°„ ë°ì´í„° ìŠ¤íŠ¸ë¦¬ë°
**ëª©í‘œ**: ì‹¤ì‹œê°„ ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘ ë° ì „ëµ ì‹œë®¬ë ˆì´ì…˜

#### êµ¬í˜„ ë°©ë²•
- **WebSocket**: ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ 
- **Supabase Realtime**: ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½ ì‚¬í•­ ì‹¤ì‹œê°„ êµ¬ë…

#### êµ¬í˜„ ë‚´ìš©
```python
# backend/app/services/live_monitor.py

class LiveMonitor:
    """ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§"""

    async def stream_market_data(self, symbol: str):
        """ì‹¤ì‹œê°„ ì‹œì¥ ë°ì´í„° ìŠ¤íŠ¸ë¦¼"""
        async with websocket.connect(f"wss://api.binance.com/ws/{symbol}@trade") as ws:
            async for message in ws:
                # ë°ì´í„° ì²˜ë¦¬ ë° ì „ëµ ì‹¤í–‰
                pass
```

---

## 7ë‹¨ê³„: ì•Œë¦¼ ë° ë¦¬í¬íŠ¸

### 7.1 ë°±í…ŒìŠ¤íŠ¸ ì™„ë£Œ ì•Œë¦¼
**ëª©í‘œ**: ë°±í…ŒìŠ¤íŠ¸ ì™„ë£Œ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼

#### ì•Œë¦¼ ë°©ë²•
- ì´ë©”ì¼ (SendGrid, AWS SES)
- ì›¹ í‘¸ì‹œ ì•Œë¦¼
- Slack/Discord ì›¹í›…

### 7.2 PDF ë¦¬í¬íŠ¸ ìƒì„±
**ëª©í‘œ**: ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ PDFë¡œ ë‚´ë³´ë‚´ê¸°

#### êµ¬í˜„ ë¼ì´ë¸ŒëŸ¬ë¦¬
- `reportlab` (Python)
- `jsPDF` (JavaScript)

---

## ìš°ì„ ìˆœìœ„

### ë†’ì€ ìš°ì„ ìˆœìœ„ (ì¦‰ì‹œ êµ¬í˜„)
1. âœ… ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì—”ì§„ (1ë‹¨ê³„)
2. âœ… ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘ (2ë‹¨ê³„)
3. âœ… ì„±ê³¼ ë¶„ì„ (3ë‹¨ê³„)

### ì¤‘ê°„ ìš°ì„ ìˆœìœ„ (ë‹¤ìŒ ë‹¨ê³„)
4. âœ… ì°¨íŠ¸ ë° ì‹œê°í™” (4ë‹¨ê³„)
5. âœ… ì „ëµ ìµœì í™” (5ë‹¨ê³„)

### ë‚®ì€ ìš°ì„ ìˆœìœ„ (í–¥í›„ ê²€í† )
6. ğŸ”² ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ (6ë‹¨ê³„)
7. ğŸ”² ì•Œë¦¼ ë° ë¦¬í¬íŠ¸ (7ë‹¨ê³„)

---

## ê¸°ìˆ  ìŠ¤íƒ ì¶”ê°€ ìš”êµ¬ì‚¬í•­

### Python íŒ¨í‚¤ì§€
```txt
# ë°ì´í„° ì²˜ë¦¬
pandas==2.1.0
numpy==1.24.3

# ê¸°ìˆ  ì§€í‘œ
TA-Lib==0.4.28
pandas-ta==0.3.14b

# ë°ì´í„° ìˆ˜ì§‘
yfinance==0.2.28
python-binance==1.0.19
ccxt==4.1.0

# ë°±í…ŒìŠ¤íŒ…
backtrader==1.9.78.123  # ë˜ëŠ” ì§ì ‘ êµ¬í˜„

# ìµœì í™”
scikit-optimize==0.9.0
optuna==3.4.0

# ì½”ë“œ ìƒŒë“œë°•ì‹±
RestrictedPython==6.2

# ë¹„ë™ê¸° ì‘ì—…
celery==5.3.4
redis==5.0.1
```

### í”„ë¡ íŠ¸ì—”ë“œ íŒ¨í‚¤ì§€
```json
{
  "dependencies": {
    "chart.js": "^4.4.0",
    "react-chartjs-2": "^5.2.0",
    "lightweight-charts": "^4.1.0",
    "date-fns": "^2.30.0",
    "recharts": "^2.10.0"
  }
}
```

---

## ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ê°œì„ 

### ì¶”ê°€ í…Œì´ë¸”

#### bt_optimization_jobs (ìµœì í™” ì‘ì—…)
```sql
CREATE TABLE bt_optimization_jobs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    strategy_id UUID REFERENCES bt_strategies(id),
    status VARCHAR(50) DEFAULT 'pending',
    method VARCHAR(50),  -- 'grid', 'random', 'bayesian'
    param_ranges JSONB,
    best_params JSONB,
    best_score DECIMAL(10, 4),
    progress INTEGER DEFAULT 0,
    total_iterations INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE
);
```

#### bt_alerts (ì•Œë¦¼)
```sql
CREATE TABLE bt_alerts (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID,  -- í–¥í›„ ë‹¤ì¤‘ ì‚¬ìš©ì ì§€ì› ì‹œ
    backtest_id UUID REFERENCES bt_backtests(id),
    type VARCHAR(50),  -- 'email', 'push', 'webhook'
    message TEXT,
    sent_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## ë°°í¬ ë° ìš´ì˜

### Fly.io ë°°í¬ ì‹œ ê³ ë ¤ì‚¬í•­
1. **í™˜ê²½ ë³€ìˆ˜ ì„¤ì •**
   ```bash
   flyctl secrets set SUPABASE_URL=...
   flyctl secrets set SUPABASE_SERVICE_ROLE_KEY=...
   ```

2. **Redis ì¶”ê°€** (Celery ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…ìš©)
   ```bash
   flyctl redis create
   ```

3. **ìŠ¤ì¼€ì¼ë§**
   ```bash
   flyctl scale count 2  # ì¸ìŠ¤í„´ìŠ¤ ê°œìˆ˜ ì¡°ì •
   flyctl scale vm shared-cpu-1x  # VM í¬ê¸° ì¡°ì •
   ```

---

## ê°œë°œ ë¡œë“œë§µ

### Phase 1: ì½”ì–´ ê¸°ëŠ¥ (2-3ì£¼)
- [x] í”„ë¡œì íŠ¸ ê¸°ë³¸ êµ¬ì¡°
- [ ] ë°±í…ŒìŠ¤íŠ¸ ì—”ì§„ êµ¬í˜„
- [ ] ë°ì´í„° ìˆ˜ì§‘ API
- [ ] ê¸°ë³¸ ì„±ê³¼ ë¶„ì„

### Phase 2: ì‹œê°í™” (1-2ì£¼)
- [ ] ì°¨íŠ¸ ì»´í¬ë„ŒíŠ¸ ê°œë°œ
- [ ] ëŒ€ì‹œë³´ë“œ ê°œì„ 
- [ ] ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ í˜ì´ì§€

### Phase 3: ê³ ê¸‰ ê¸°ëŠ¥ (2-3ì£¼)
- [ ] íŒŒë¼ë¯¸í„° ìµœì í™”
- [ ] ì „ëµ ë¹„êµ ê¸°ëŠ¥
- [ ] PDF ë¦¬í¬íŠ¸ ìƒì„±

### Phase 4: ë°°í¬ ë° ìµœì í™” (1ì£¼)
- [ ] Fly.io ë°°í¬
- [ ] ì„±ëŠ¥ ìµœì í™”
- [ ] ëª¨ë‹ˆí„°ë§ ì„¤ì •

---

## ì°¸ê³  ìë£Œ

### ë°±í…ŒìŠ¤íŒ… ë¼ì´ë¸ŒëŸ¬ë¦¬
- [Backtrader](https://www.backtrader.com/)
- [Zipline](https://zipline.ml4trading.io/)
- [VectorBT](https://vectorbt.dev/)

### ë°ì´í„° ì†ŒìŠ¤
- [Yahoo Finance](https://finance.yahoo.com/)
- [Binance API](https://binance-docs.github.io/apidocs/)
- [Upbit API](https://docs.upbit.com/)

### ì‹œê°í™”
- [TradingView Lightweight Charts](https://www.tradingview.com/lightweight-charts/)
- [Recharts](https://recharts.org/)

---

## ë¼ì´ì„ ìŠ¤ ë° ì£¼ì˜ì‚¬í•­

### ì£¼ì˜ì‚¬í•­
- ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ëŠ” ê³¼ê±° ë°ì´í„° ê¸°ë°˜ì´ë©° ë¯¸ë˜ ìˆ˜ìµì„ ë³´ì¥í•˜ì§€ ì•ŠìŒ
- ì‹¤ì œ ê±°ë˜ ì‹œ ìŠ¬ë¦¬í”¼ì§€, ìˆ˜ìˆ˜ë£Œ ë“± ì¶”ê°€ ë¹„ìš© ê³ ë ¤ í•„ìš”
- ê³¼ìµœì í™”(overfitting) ì£¼ì˜

### ë¼ì´ì„ ìŠ¤
- ê°œì¸ ì‚¬ìš© ëª©ì 
- ìƒì—…ì  ì‚¬ìš© ì‹œ ë³„ë„ ë¼ì´ì„ ìŠ¤ í•„ìš”

---

**ë¬¸ì„œ ì‘ì„±ì¼**: 2025-01-15
**ë²„ì „**: 1.0
